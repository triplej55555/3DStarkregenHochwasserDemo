<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="utf-8">
  <title>Starkregen/Hochwasser Demo </title>
  <!-- Include the CesiumJS JavaScript and CSS files -->

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>

  <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script src="./cesium-drawhelper-master/cesium-drawhelper-master/DrawHelper.js"> </script>
  <style>
    @import url('./cesium-drawhelper-master/cesium-drawhelper-master/DrawHelper.css');

    body{
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        display: block;
    }
    #cesiumContainer {
        position: absolute;
        width: 100%;
        height: 100%;
        
    }
    #header{
      display: flex;
      position: absolute;
      align-items: center;
      text-align: center;
      justify-content: center;
      align-content: center;
      background-color: rgba(12, 11, 11, 1);
      border: 0 solid black;
      color: white;
      font-size: 25px;
      height: 50px;
      width: 100%;
      z-index: 1000;
      font-family: Arial, Helvetica, sans-serif;
    }
    #header img {
      margin-right: 10px; /* Adjust the value to control the space between the image and the text */
    }

    #header span {
      display: inline-block;
    } 
  
    .cesium-viewer-toolbar {
      position: absolute;
      top: 5px;
      right: 48px;
      z-index: 1000;
    }
    /* General styles for all infoboxes */
    .cesium-infoBox {
            background-color: rgba(180, 189, 189, 0.911) ; /* Default infobox background color */
            color: rgb(247, 244, 244) !important
        }


.button-container {
  display: flex;
  position: absolute;
  justify-content: center;
  height:  50px;
  gap: 5px;
  top: 80px;
  left: 50%; 
  transform: translate(-50%, -50%); 
  z-index: 1000;
}
.btn {
  height: 35px;
}

.button-container2 {
  display: flex;
  position: absolute;
  justify-content: center;
  height:  50px;
  gap: 5px;
  top: 7px;
  left: 6px; 
   
  z-index: 1000;
}

#Funktionsleiste {
  z-index: 1000;
      background: white;
      color: black;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
}
#layerbutton {
        
      z-index: 1000;
      background: white;
      color: black;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
      
    }
    #legendbutton {
  
      background: white;
      color: black;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
      
    }
    #counterButton {
        
        z-index: 1000;
        background: white;
        color: black;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 10px;
        font-family: Arial, Helvetica, sans-serif;
        
      }
      #counterButton2 {
        
        z-index: 1000;
        background: white;
        color: black;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 10px;
        font-family: Arial, Helvetica, sans-serif;
        
      }

      #drawPolygonButton {
        background: white;
      color: black;
      padding: 0px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
      width: fit-content;
      display: inline-block;
      align-content: center;
      justify-content: center;
      align-items: center;
      text-align: center;
      }
      #favoriteInput {
        position: absolute; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        z-index: 3000; 
        background: white; 
        padding: 5px; 
        border: 3px solid yellow; 
        display: none; 
        width: 300px; 
        height: 20%;
      }
     #favoriteInput:focus {
      border-color: yellow;
      box-shadow: 0 0 5px rgba(102, 175, 233, 0.5);
      outline: none;
    }

    #zweid3dButton {
      position: absolute;
      top: 7px;
      right: 5px;
      height: 32px;
      z-index: 1000;
      background: #323436da;
      color: white;
      padding: 2px;
      border: 1px solid #cccccc42;
      border-radius: 5px;
      font-family: Arial, Helvetica, sans-serif;
      font-weight: bold;
      align-content: center;      
    }
    #zweid3dButton:hover {
  background: #4488bb; /* Change background color on hover */
  border: white solid 1px;
  box-shadow: 0px 0px 0px 2px rgba(255, 255, 255, 0.308);
  border-radius: 5px;
  color: #fff;      /* Change text color on hover */
}

 .layer-list {
      display: none;
      position: absolute;
      top: 38px;
      left: 8px;
      background: white;
      color: black;
      padding: 10px;
      border: black solid 1px;
      border-radius: 10px;
      list-style: none;
      font-family: Arial, Helvetica, sans-serif;
      z-index: 100;
      width: 400px;
    }
    .layer-list li {
      margin-bottom: 5px;
    }
    
    #legend {
      display: none;      
      position: absolute;
      bottom: 45px;
      left: 8px;
            background-color: rgb(255, 255, 255);
            padding: 10px;
            border-radius: 10px;
            border: black solid 1px;
            z-index: 200;
            display: none;
            font-family: Arial, Helvetica, sans-serif;
            text-align: left;
            align-items: center;
            width: 200px;
            height: 225px;
        }
        #legend img {
            max-width: 300px;
        }
    
        #sliderContainer {
            position: absolute;
            top: 45px;
            right: 700px;
            width: 10%;
            padding: 10px;
            text-align: center;
            z-index: 1; /* Ensure the slider is above the Cesium container */
        }

        
    #StartRainButton {
      
      background: white;
      color: black;
      padding: 1px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
      width: fit-content;
      display: inline-block;
      align-content: center;
      justify-content: center;
      align-items: center;
    }
    #StopRainButton {
      
      background: white;
      color: black;
      padding: 1px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
      width: fit-content;
      display: none;
    }

    #boatButton {
      background: white;
      color: black;
      padding: 1px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
      width: fit-content;
      display: inline-block;
      align-content: center;
      justify-content: center;
      align-items: center;
    }

    #rain {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 200;
}
.RainIntensity {  
    height: 33px;
    background: white;
    color: black;
    padding: 0px;
    font-size: 10px;
    border: 1px solid #ccc;
    border-radius: 10px;
    list-style: none;
    font-family: Arial, Helvetica, sans-serif;
    width: 110px;
    margin-top: 1px;
    
    
}
#RainIntensity {
  display: none;
}

.RainIntensity li {
    display: flex;
    align-items: center;
    margin-bottom: 0px;
    margin-left: 5px;
    margin-top: 1px;
}

.RainIntensity input[type="checkbox"] {
    margin-right: 10px;
}

#FavoritenAuswahlButton {
  background: white;
      color: black;
      padding: 1px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
      width: fit-content;
      align-items: center;
      justify-content: center;
      align-content: center;
        }

#drawPolygonButton {
  background: white;
      color: black;
      padding: 1px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: Arial, Helvetica, sans-serif;
      width: fit-content;
      align-items: center;
      justify-content: center;
      align-content: center;
        }



.smallCheckBox {
            width: 10px;
            height: 10px;
            
        }

.drop {
    position: absolute;
    bottom: 100%;
    width: 1px;
    height: 100px;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.5));
    animation: fall linear infinite;
}

#confirmationModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

#confirmationModal2 {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}




@keyframes fall {
      to {
        transform: translateY(100vh);
      }
    }
  </style>
</head>

<body>
<script src="./pwd/pwd.js"></script>

  
<div id="cesiumContainer">
  <div id= "header">
    <i class="fa-solid fa-house-flood-water" style="margin-right: 7px; "></i>
    
    <span style="margin-left: 0px; margin-right: -5px;"> 3D Starkregen / Hochwasser Demo &nbsp</span> 
    <i class="fa-solid fa-cloud-showers-heavy"></i>
    
    <div class="button-container2">
      <button class="btn" id="Funktionsleiste" title="Funktionsleiste ein-/ausblenden">
        <i class="fa-solid fa-bars" style="font-size: 20px; position: relative; top: -2px; width: fit-content;"></i>
      </button>
      <button class= "btn" id="layerbutton" title="Layer"><strong>Layer</strong></button>
    <button class= "btn" id="legendbutton" title="Legende"><strong>Legende</strong></button>
    </div>
  </div>
  <div class="button-container" id="header2">
    <button class= "btn" id="StartRainButton" title="Regen starten"> <i class="fa-solid fa-cloud-rain" aria-hidden="true" style="font-size: 24px; color: blue; position: relative;top: 0px; left: 0px; display: inline-block; margin-right: 5px; margin-left: 5px;"></i><i class="fa fa-play-circle" style="font-size:24px;color:green; position: relative;top: 0px; left: 0px; display: none; margin-right: 2px;"></i> </button>
    <button class= "btn" id="StopRainButton" title="Regen stoppen"> <i class="fa-solid fa-cloud-rain" aria-hidden="true" style="font-size: 24px; color: blue; position: relative;top: 0px; left: 0px; display: inline-block; margin-right: 5px; margin-left: 2px;"></i><i class="fa fa-stop-circle-o" style="font-size:24px;color:red; position: relative;top: 0px; left: 0px; display: inline-block; margin-right: 2px;"></i> </button>
    <ul class="RainIntensity" id="RainIntensity">
      <li> 
          <input type="checkbox" id="lightRain" class="smallCheckBox">
          <label for="lightRain"><strong>Leichter Regen</strong></label>
      </li>
      <li>
          <input type="checkbox" id="heavyRain" class="smallCheckBox">
          <label for="mediumRain"><strong>Starker Regen</strong></label>
      </li>
    </ul>
    <button class="btn" id="boatButton">
      <i id = "boat"  title="Boot Animation starten" class="fa-solid fa-sailboat" style="font-size: 20px; color: rgb(24, 24, 20); margin-left: 3px; margin-right: 3px;"></i>
      
      <i id = "startBoat" class="fa fa-play-circle" title="Boot Animation starten" style="font-size:24px;color:green; position: relative;top: 0px; left: 0px; display: none; margin-right: 2px;"></i>
      <i id = "stopBoat" title="Boot Animation stoppen" class="fa fa-stop-circle-o" style="font-size:24px;color:red; position: relative;top: 0px; left: 0px; display: none; margin-right: 2px; margin-left: 0px;"></i>
    </button>
      <button class= "btn" id="FavoritenAuswahlButton" >
        
        
        <i class="fa-regular fa-star" aria-hidden="true" style="font-size: 24px; position:relative;top: 0px; left: 0px; display: inline-block; margin-right: 0px; margin-left: 2px;"></i>
        <i id ="startFavorites" title="Favoriten Auswahl starten" class="fa-regular fa-hand-pointer" style="font-size:24px;color:green; position: relative;top: 0px; left: 0px; display: inline-block;margin-right: 2px; margin-left: 0px;"></i>
        <i id = "stopFavorites" title="Favoriten Auswahl stoppen" class="fa fa-stop-circle-o" style="font-size:24px;color:red; position: relative;top: 0px; left: 0px; display: none; margin-right: 2px; margin-left: 0px;"></i>
        <i id="deleteFavorites" title="Alle Favoriten löschen" class="fa fa-trash-o" aria-hidden="true" style="font-size:24px;color:red; position: relative;top: 0px; left: 0px; display: none; margin-right: 2px; margin-left: -1px" ></i>

      </button>
      <button class= "btn" id="counterButton" style="display: inline-block;" ><strong>Favoriten: 0</strong></button>
      <button class= "btn" id= "drawPolygonButton" > 
        <i class="fa-solid fa-draw-polygon" id="startPolygon" title="Polygon-Zeichnen Modus aktivieren" aria-hidden="true" style="font-size:24px;color:black; position: relative;top: 1px; left: 0px; display: inline-block;margin-right: 5px; margin-left: 5px;"></i>
        <i id ="drawPolygon" title="Polygon Zeichnen" class="fa-solid fa-pencil" style="font-size:20px;color:green; position: relative;top: 0px; left: 0px; display: none;margin-right: 2px; margin-left: 5px;"></i>
        <label for="colorSelect"> </label>
        <select id="colorSelect" title="Polygon-Farbe" style="display: none; margin-left: 0px; margin-right: 4px; vertical-align: middle; height: 24px; width: fit-content; position: relative;top: -3px;">
          <option value="RED">Rot</option>
          <option value="GREEN">Grün</option>
          <option value="BLUE">Blau</option>
        </select>
        <i id = "stopPolygon" title="Polygon Zeichnen stoppen" class="fa fa-stop-circle-o" style="font-size:24px;color:red; position: relative;top: 2px; left: 0px; display: none; margin-right: 2px; margin-left: 0px;"></i>
        <i id="deletePolygon" title="Alle Polygone löschen" class="fa fa-trash-o" aria-hidden="true" style="font-size:24px;color:red; position: relative;top: 0px; left: 0px; display: none; margin-right: 2px; margin-left: -1px" ></i>
        
      </button>
      <button class= "btn" id="counterButton2" style="display: inline-block" ><strong>Polygone: 0</strong></button>
  
    </div>
</div>



<input type="text" id="favoriteInput" placeholder="Kommentar eingeben">
<button id="zweid3dButton">2D/3D</button>


<div id= "rain"></div>

<ul class="layer-list" id= "layerlist">
  <li>
    <strong>Favoriten</strong>
  </li>
  <li>
    <input type="checkbox" id="FavoritenCheckbox" checked>
    <label for="FavoritenCheckbox">Favoriten</label>
  </li>
  <br>
  <li>
    <strong>Polygone</strong>
  </li>
  <li>
    <input type="checkbox" id="PolygonCheckbox" checked>
    <label for="PolygonCheckbox">Polygone</label>
  </li>
  <br>
  <li>
    <strong>3D Gebäude</strong>
  </li>
  <li>
    <input type="checkbox" id="OSMCheckbox">
    <label for="OSMCheckbox">OSM 3D Buildings</label>
  </li>
  <li>
    <input type="checkbox" id="GooglePhotorealisticCheckbox" >  <!-- 'check ed' hier bedeutet ist beim Start an! -->
    <label for="GooglePhotorealisticCheckbox">Google Photorealistic</label>
  </li>
  <li>
    <input type="checkbox" id="LoD2Checkbox" checked>
    <label for="LoD2Checkbox">LoD2</label>
  </li>
  <br>
  <li>
    <strong> Starkregen</strong>
  </li>
  <li>
    <input type="checkbox" id="wmsStarkregenSeltenCheckbox">
    <label for="wmsStarkregenSeltenCheckbox">WMS Starkregen selten</label>
  </li>
  <li>
    <input type="checkbox" id="wmsStarkregenExtremCheckbox">
    <label for="wmsStarkregenExtremCheckbox">WMS Starkregen extrem</label>
  </li>
  <br>
  <li>
   <strong> Hochwasser</strong>
  </li>
  <li>
    <input type="checkbox" id="RheinPegelCheckbox" checked>
    <label for="RheinPegelCheckbox">Rheinpegel</label>
  </li>
  <li>
    
    <div class="slider-container">
      <input type="checkbox" id="HochwasserCheckbox">
      <label for="layerSlider"></label>
      <input type="range" id="layerSlider" min="0" max="2" value="0">
      <div class="slider-labels" style="font-size: 14px;">
          <span>  &nbsp   &nbsp    </span>
          <span>HQ10</span>
          <span>&nbsp &nbsp HQ100</span>
          <span>&nbsp &nbsp HQ500</span>
      </div>
    </li>
    <li> <strong>3D</strong></li>
  </li>
      <li>
        <input type="checkbox" id="HochwasserSelten3D">
        <label for="HochwasserSelten3D">3D HQ100 Überschwemmungsgebiete</label>
      </li>
      <li>
        <input type="checkbox" id="HochwasserSelten3D_UG">
        <label for="HochwasserSelten3D_UG">3D HQ100 Überschwemmungsgefährdete Gebiete</label>
      </li>
      <li>
        <input type="checkbox" id="HochwasserExtrem3D">
        <label for="HochwasserExtrem3D">3D HQ500 Überschwemmungsgebiete</label>
      </li>
    
</ul>
<div id="legend">
  <strong>Wasserhöhen</strong> <br> <img id="legendImage" src="img/Wasserhoehe_legende.png" style="width: 200px; align-items: center;" alt="Legend"> 
 </div>
 
 <!-- Favoriten Confirmation Modal -->
<div id="confirmationModal" style="display:none;">
  <div style="padding: 20px; border: 1px solid #ccc; background-color: #fff; max-width: 300px; margin: auto; text-align: center;">
      <p><strong>Möchtest du wirklich alle Favoriten löschen?</strong></p>
      <p>Um einzelne Favoriten zu löschen nutze den Rechtsklick auf die jeweiligen Favoriten</p>
      <button id="confirmDelete">Löschen</button>
      <button id="cancelDelete">Abbrechen</button>
  </div>
</div>

 <!-- Polygon Confirmation Modal -->
 <div id="confirmationModal2" style="display:none;">
  <div style="padding: 20px; border: 1px solid #ccc; background-color: #fff; max-width: 300px; margin: auto; text-align: center;">
      <p><strong>Möchtest du wirklich alle Polygone löschen?</strong></p>
      <p>Um einzelne Polygone zu löschen nutze den Rechtsklick auf die jeweiligen Polygone</p>
      <button id="confirmDelete2">Löschen</button>
      <button id="cancelDelete2">Abbrechen</button>
  </div>
</div>

<!-- Script for Cesium Application-->
  <script type="module">
    // Your access token can be found at: https://ion.cesium.com/tokens.
    // This is the default access token from your ion account
    

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5MGMxODg4OC1kMzY3LTQ2YWEtOGE3ZC02NTZhMjhlYzMyM2IiLCJpZCI6MjE4NTkzLCJpYXQiOjE3MTY5NjA1Nzl9.g7iklh7XUTw185GhAkjNQVQuJsW13ZAgKAsTQM2_MvI';
    
    const imageryProviders = [
            new Cesium.ProviderViewModel({
                name: 'OSM',
                iconUrl: Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/openStreetMap.png'),
                tooltip: 'OpenStreetMap',
                creationFunction: function() {
                    return new Cesium.OpenStreetMapImageryProvider({
                        url : 'https://a.tile.openstreetmap.org/'
                    });
                }
            }),
            // WMS DOP NRW
            new Cesium.ProviderViewModel({
                name: 'DOP NRW',
                iconUrl: Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/bingAerial.png'),
                tooltip: 'DOP NRW',
                creationFunction: function() {
                    return new Cesium.WebMapServiceImageryProvider({
                  url: 'https://www.wms.nrw.de/geobasis/wms_nw_dop?',
                  layers : 'nw_dop_rgb',
                      parameters : {
                          service: 'WMS',
                          version: '1.3.0',
                          request: 'GetMap',
                          styles: '',
                          format: 'image/png', 
                          srs: 'EPSG:4326' // Use 'srs' for WMS version 1.1.1
                          }})
                          }
            }),
            //Top Plus Open Grau
            new Cesium.ProviderViewModel({
                name: 'TopPlus Grau',
                iconUrl: Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/bingRoads.png'),
                tooltip: 'TopPlus Grau',
                creationFunction: function() {
                    return new Cesium.WebMapServiceImageryProvider({
                  url: 'https://sgx.geodatenzentrum.de/wms_topplus_open?',
                  layers : 'web_grau',
                      parameters : {
                          service: 'WMS',
                          version: '1.3.0',
                          request: 'GetMap',
                          styles: '',
                          format: 'image/png', 
                          srs: 'EPSG:4326' // Use 'srs' for WMS version 1.1.1
                          }})
                          }
            }),
        ];

    // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
    const viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider: await Cesium.CesiumTerrainProvider.fromIonAssetId(1)     //Cesium.Terrain.fromAssetId(2599342)  // // Cesium.Terrain.fromWorldTerrain(), for world Terrain
    ,
    navigationHelpButton: false,
    animation: false,
    timeline: false,
      infoBox: true,
      selectionIndicator: true,
      sceneModePicker: false, // change back when it works
      //imageryProvider: false,
            imageryProviderViewModels: imageryProviders,
            selectedImageryProviderViewModel: imageryProviders[1], // Select DOP als default
            baseLayerPicker: true, 
      });
      
        // Enable depth testing so things behind the terrain are not visible
  viewer.scene.globe.depthTestAgainstTerrain = true;


//startView and Fly the camera Cologne at the given longitude, latitude, and height.
const initialPosition = Cesium.Cartesian3.fromDegrees(6.958, 50.930, 600); // Long, Lat, Height
const initialOrientation = {
  heading: Cesium.Math.toRadians(0.0),
  pitch: Cesium.Math.toRadians(-15.0),
};
    viewer.camera.flyTo({
      destination:initialPosition,
      orientation: initialOrientation
    });

    // Configure the home button to fly back to the initial view
  viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function(commandInfo) {
  viewer.scene.camera.flyTo({
    destination: initialPosition,
    orientation: initialOrientation,
    duration: 3.0 // Duration in seconds
  });
  commandInfo.cancel = true; // Cancel the default home button action
});
    

// Favoritenauswahl
let FavoritenAuswahl = false;
const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

function generateRandomId() {
    return Math.floor(Math.random() * 1000000);
}

// Array to keep track of FavoritenMarker entities
var FavoritenMarkersArray = [];
var favoriteCounter = 0;

// Load saved FavoritenMarker on startup
loadFavorites();

// Update the favorite counter display
function updateFavoriteCounter() {
    document.getElementById('counterButton').innerHTML = `<strong>Favoriten: ${favoriteCounter}</strong>`;
    if (favoriteCounter > 0) {
        //document.getElementById('counterButton').style.display = 'inline-block';
        document.getElementById('deleteFavorites').style.display = 'inline-block';
    } else {
        //document.getElementById('counterButton').style.display = 'none';
        document.getElementById('deleteFavorites').style.display = 'none';
    }
        
}

// Function to show the input field and enable FavoritenAuswahl
function showFavoriteInput() {
    document.getElementById('favoriteInput').style.display = 'block';
    document.getElementById('favoriteInput').focus();
}

// Function to hide the input field and disable FavoritenAuswahl
function hideFavoriteInput() {
    document.getElementById('favoriteInput').style.display = 'none';
    document.getElementById('favoriteInput').value = ''; // Clear the input field
}

// Add a click event listener to the viewer to place a FavoritenMarker and save coordinates
handler.setInputAction(function (click) {
    if (!FavoritenAuswahl) return;
    var earthPosition = viewer.scene.pickPosition(click.position);
    if (Cesium.defined(earthPosition)) {
        var cartographic = Cesium.Cartographic.fromCartesian(earthPosition);
        var latitude = Cesium.Math.toDegrees(cartographic.latitude);
        var longitude = Cesium.Math.toDegrees(cartographic.longitude);

        showFavoriteInput();

        document.getElementById('favoriteInput').addEventListener('keypress', function onEnter(e) {
            if (e.key === 'Enter') {
                // Get the text input from the user
                var text = document.getElementById('favoriteInput').value;

                // Add a FavoritenMarker at the clicked position
                var FavoritenMarker = addFavoritenMarker(earthPosition, latitude, longitude, text);

                // Save coordinates to local storage
                saveCoordinate(latitude, longitude, text);

                // Increment and update the favorite counter
                favoriteCounter++;
                updateFavoriteCounter();

                // Hide the input field after setting the favorite
                hideFavoriteInput();

                // Remove the event listener after use
                document.getElementById('favoriteInput').removeEventListener('keypress', onEnter);
            }
        });
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

// Function to add a FavoritenMarker to the viewer and keep track of it
function addFavoritenMarker(position, latitude, longitude, text) {
    const id = generateRandomId();
    var FavoritenMarker = viewer.entities.add({
        position: position,
        billboard: {
            image: new Cesium.PinBuilder().fromMakiIconId("star", Cesium.Color.fromCssColorString('#242a2d'), 48),
            width: 50,
            height: 50,
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
            verticalOrigin: Cesium.VerticalOrigin.CENTER,
            horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
            disableDepthTestDistance: Number.POSITIVE_INFINITY,
            distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, Number.POSITIVE_INFINITY)
        },
        id: id,
        properties: {
            latitude: latitude,
            longitude: longitude,
            text: text
        },
        customInfobox: true // to enable custom infobox
    });
    FavoritenMarkersArray.push(FavoritenMarker);
    return FavoritenMarker;
}

// Function to save coordinates to local storage
function saveCoordinate(lat, lng, text) {
    var favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    favorites.push({ lat: lat, lng: lng, text: text });
    localStorage.setItem('favorites', JSON.stringify(favorites));
}

// Function to load saved coordinates from local storage and display them
function loadFavorites() {
    var favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    favorites.forEach(function (coord) {
        var position = Cesium.Cartesian3.fromDegrees(coord.lng, coord.lat);
        addFavoritenMarker(position, coord.lat, coord.lng, coord.text);
    });
    // Set the counter to the number of loaded favorites
    favoriteCounter = favorites.length;
    updateFavoriteCounter();
}

// Function to clear all FavoritenMarker from the viewer and local storage
function clearMarkers() {
    // Remove only FavoritenMarker entities
    FavoritenMarkersArray.forEach(function (FavoritenMarker) {
        viewer.entities.remove(FavoritenMarker);
    });
    FavoritenMarkersArray = [];  // Clear the FavoritenMarkersArray array
    localStorage.removeItem('favorites');

    // Reset the counter
    favoriteCounter = 0;
    updateFavoriteCounter();
}

// Add an event listener to the clear markers button
// Show the custom confirmation modal
document.getElementById('deleteFavorites').addEventListener('click', function() {
    document.getElementById('confirmationModal').style.display = 'flex';
});

// Handle the OK button in the custom modal
document.getElementById('confirmDelete').addEventListener('click', function() {
    clearMarkers();
    document.getElementById('confirmationModal').style.display = 'none';
});

// Handle the Cancel button in the custom modal
document.getElementById('cancelDelete').addEventListener('click', function() {
    document.getElementById('confirmationModal').style.display = 'none';
});

// Add an event listener to delete individual FavoritenMarker on right-click
handler.setInputAction(function (click) {
    var pickedObject = viewer.scene.pick(click.position);
    if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
        var FavoritenMarker = pickedObject.id;

        // Check if this entity is a favorite marker by checking for specific properties
        if (Cesium.defined(FavoritenMarker.properties) && 
            Cesium.defined(FavoritenMarker.properties.latitude) && 
            Cesium.defined(FavoritenMarker.properties.longitude)) {

            var lat = FavoritenMarker.properties.latitude.getValue();
            var lng = FavoritenMarker.properties.longitude.getValue();

            // Remove the marker entity from the viewer
            viewer.entities.remove(FavoritenMarker);

            // Remove the marker from the FavoritenMarkersArray
            FavoritenMarkersArray = FavoritenMarkersArray.filter(marker => marker !== FavoritenMarker);

            // Remove the marker coordinates from local storage
            var favorites = JSON.parse(localStorage.getItem('favorites')) || [];
            favorites = favorites.filter(coord => coord.lat !== lat || coord.lng !== lng);
            localStorage.setItem('favorites', JSON.stringify(favorites));

            // Decrement and update the favorite counter
            favoriteCounter--;
            updateFavoriteCounter();

            console.log('Favorite marker deleted:', FavoritenMarker);
        }
    }
}, Cesium.ScreenSpaceEventType.RIGHT_CLICK);


// Add attributes to the Cesium infobox for the new features
viewer.selectedEntityChanged.addEventListener(function () {
    var entity = viewer.selectedEntity;
    if (Cesium.defined(entity)) {
        // Check if the entity has the customInfobox property
        if (entity.customInfobox) {
            var id = entity.id;
            var latitude = entity.properties.latitude.getValue();
            var longitude = entity.properties.longitude.getValue();
            var text = entity.properties.text.getValue();

            // Create infobox content
            var infoboxContent = `
                <table>
                    <tr><td>ID:</td><td>${id}</td></tr>
                    <tr><td>Latitude:</td><td>${latitude}</td></tr>
                    <tr><td>Longitude:</td><td>${longitude}</td></tr>
                    <tr><td>Kommentar:</td><td>${text}</td></tr>
                </table>
            `;

            // Set the infobox description
            entity.description = new Cesium.ConstantProperty(infoboxContent);
            entity.name = "Favorit";
        }
    }
});

// Infobox for Polygons: Add attributes to the Cesium infobox for the new features
viewer.selectedEntityChanged.addEventListener(function () {
    var entity = viewer.selectedEntity;
    if (Cesium.defined(entity)) {
        // Check if the entity has the customInfobox property
        if (entity.customInfobox2) {
            var id = entity.id;
            

            // Create infobox content
            var infoboxContent2 = `
                <table>
                    <tr><td>ID:</td><td>${id}</td></tr>
                    
                </table>
            `;

            // Set the infobox description
            entity.description = new Cesium.ConstantProperty(infoboxContent2);
            entity.name = "Polygon";
        }
    }
});
// Event listeners for starting and stopping favorite selection mode
document.getElementById('startFavorites').addEventListener('click', function () {
    document.getElementById('startFavorites').style.display = 'none';
    document.getElementById('stopFavorites').style.display = 'inline-block';
    showAllMarkers();
    document.getElementById('FavoritenCheckbox').checked = true;
    FavoritenAuswahl = true;
    toggleView(-90, 0.01, 1200);
    document.getElementById('zweid3dButton').style.display = "none";
    viewer.infoBox.container.style.display = 'none'; // Make sure Infobox does not show up when elements are clicked
    document.getElementById('drawPolygonButton').style.display = 'none'; //disable draw Polygon while Favorite Selection
    
  });

document.getElementById('stopFavorites').addEventListener('click', function () {
    document.getElementById('startFavorites').style.display = 'inline-block';
    document.getElementById('stopFavorites').style.display = 'none';
    showAllMarkers();
    document.getElementById('FavoritenCheckbox').checked = true;
    FavoritenAuswahl = false;
    toggleView(-15, -0.01, 600);
    document.getElementById('zweid3dButton').style.display = "block";
    viewer.infoBox.container.style.display = 'block'; // Make sure Infobox shows up again when elements are clicked
    hideFavoriteInput();
    document.getElementById('drawPolygonButton').style.display = 'inline-block'; //enable draw Polygon after Favorite Selection
});


// Polygon Tool 
 //Activate Polygon Tool
 document.getElementById('startPolygon').addEventListener('click', function() {
    toggleView(-90, 0.01, 1200); //andere functionality noch mit einbauen??? Start/ Stopp button?
    document.getElementById('drawPolygon').style.display = 'inline-block';
    document.getElementById('colorSelect').style.display = 'inline-block';
    document.getElementById('stopPolygon').style.display = 'inline-block';
    document.getElementById('zweid3dButton').style.display = "none";
    document.getElementById('startPolygon').style.display = "none";
    LoD2Koeln.show = false;
    document.getElementById('LoD2Checkbox').checked = false;
    document.getElementById('FavoritenAuswahlButton').style.display = 'none'; //disable Favoriten Auswahl

  });

  //Deactivate Polygon Tool
  document.getElementById('stopPolygon').addEventListener('click', function() {
    toggleView(-15, -0.01, 600);
    document.getElementById('drawPolygon').style.display = 'none';
    document.getElementById('colorSelect').style.display = 'none';
    document.getElementById('stopPolygon').style.display = 'none';
    document.getElementById('zweid3dButton').style.display = "block";
    document.getElementById('startPolygon').style.display = "inline-block";
    LoD2Koeln.show = true;
    document.getElementById('LoD2Checkbox').checked = true;
    document.getElementById('FavoritenAuswahlButton').style.display = 'inline-block'; //enable Favoriten Auswahl
  });

  //Polygon Function
  var polygonEntitiesArray = [];

// Update the polygon counter display
function updatePolygonCounter() {
    document.getElementById('counterButton2').innerHTML = `<strong>Polygone: ${polygonEntitiesArray.length}</strong>`;
    if (polygonEntitiesArray.length > 0) {
        //document.getElementById('counterButton2').style.display = 'inline-block';
        document.getElementById('deletePolygon').style.display = 'inline-block';
    } else {
        //document.getElementById('counterButton2').style.display = 'none';
        document.getElementById('deletePolygon').style.display = 'none';
    }
}

//Draw Helper
var drawHelper = new DrawHelper(viewer);
var toolbar = drawHelper.addToolbar(document.getElementById('cesiumContainer'), {
    buttons: ['polygon']
});
toolbar.addListener('polygonCreated', function(event) {
    var polygon = event.primitive;
    var positions = polygon.positions;
    var id = generateRandomId();  //generate random id for the polygon

    // Convert positions to a JSON-friendly format
    var positionsArray = positions.map(function(cartesian) {
        var cartographic = Cesium.Cartographic.fromCartesian(cartesian);
        return {
            longitude: Cesium.Math.toDegrees(cartographic.longitude),
            latitude: Cesium.Math.toDegrees(cartographic.latitude),
            height: cartographic.height
        };
    });

    // Get the selected color from the color picker (or wherever you're storing it)
    var selectedColor = document.getElementById('colorSelect').value;

    // Get existing polygons from localStorage
    var savedPolygons = JSON.parse(localStorage.getItem('polygons') || '[]');

    // Add new polygon with its color to the array
    savedPolygons.push({
        positions: positionsArray,
        color: selectedColor,
        customInfobox2: true // to enable custom infobox
    });

    // Save updated polygons array to localStorage
    localStorage.setItem('polygons', JSON.stringify(savedPolygons));

    console.log('Polygon created and saved:', positionsArray, selectedColor);
});

function loadSavedPolygons() {
    var savedPolygons = JSON.parse(localStorage.getItem('polygons') || '[]');
    
    savedPolygons.forEach(function(savedPolygon) {
        var positions = savedPolygon.positions.map(function(position) {
            return Cesium.Cartesian3.fromDegrees(position.longitude, position.latitude, position.height);
        });

        var selectedColor = savedPolygon.color;

        var polygonEntity = viewer.entities.add({
          id: savedPolygon.id, // use saved id
            polygon: {
                hierarchy: positions,
                material: Cesium.Color.fromCssColorString(selectedColor).withAlpha(0.5),
                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
            },
            id: savedPolygon.id, //use saved id,
            customInfobox2: true // to enable custom infobox
        });

        // Add the loaded polygon entity to the array
        polygonEntitiesArray.push(polygonEntity);
    });
    //Update the polygon counter
    updatePolygonCounter();
}

// Call this function when your app starts
loadSavedPolygons();

document.getElementById('drawPolygon').addEventListener('click', function() {
    var selectedColor = document.getElementById('colorSelect').value;
      
    drawHelper.startDrawingPolygon({
        callback: function(positions) {
            console.log('Polygon positions:', positions);
            var id = generateRandomId();  //generate random id for the polygon
            var polygonEntity = viewer.entities.add({
                polygon: {
                    hierarchy: positions,
                    material: Cesium.Color[selectedColor.toUpperCase()].withAlpha(0.5),
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                },
                id: id, //store id as attributes
                customInfobox2: true // to enable custom infobox
            });

            // Add the polygon entity to the array
            polygonEntitiesArray.push(polygonEntity);

            // Save the new polygon to localStorage with its color (if needed)
            var positionsArray = positions.map(function(cartesian) {
                var cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                return {
                    longitude: Cesium.Math.toDegrees(cartographic.longitude),
                    latitude: Cesium.Math.toDegrees(cartographic.latitude),
                    height: cartographic.height
                };
            });

            var savedPolygons = JSON.parse(localStorage.getItem('polygons') || '[]');
            savedPolygons.push({
                positions: positionsArray,
                color: selectedColor,
                id: id,
                customInfobox2: true // to enable custom infobox
            });
            localStorage.setItem('polygons', JSON.stringify(savedPolygons));

            //Update the polygon counter
            updatePolygonCounter();
        }
        
    });
});

function updateSavedPolygons() {
    var savedPolygons = [];

    polygonEntitiesArray.forEach(function(polygonEntity) {
        var positions = polygonEntity.polygon.hierarchy.getValue().positions;

        var positionsArray = positions.map(function(cartesian) {
            var cartographic = Cesium.Cartographic.fromCartesian(cartesian);
            return {
                longitude: Cesium.Math.toDegrees(cartographic.longitude),
                latitude: Cesium.Math.toDegrees(cartographic.latitude),
                height: cartographic.height
            };
        });

        savedPolygons.push({
            positions: positionsArray,
            color: polygonEntity.polygon.material.color.getValue().toCssColorString(),
            id: id,
            customInfobox2: true // to enable custom infobox
        });
    });

    localStorage.setItem('polygons', JSON.stringify(savedPolygons));
    //Update the polygon counter
    updatePolygonCounter();
    
}

viewer.screenSpaceEventHandler.setInputAction(function onRightClick(movement) {
    var pickedObject = viewer.scene.pick(movement.position);
    if (Cesium.defined(pickedObject)) {
        var polygonEntity = pickedObject.id;

        // Check if this entity is a polygon by checking for polygon-specific attributes
        if ( polygonEntitiesArray.includes(polygonEntity)) {
            // Remove the polygon from the viewer
            viewer.entities.remove(polygonEntity);

            // Remove the polygon from the polygonEntitiesArray
            polygonEntitiesArray = polygonEntitiesArray.filter(function(item) {
                return item !== polygonEntity;
            });

            
            // Update the polygon counter after deletion
            updatePolygonCounter();

            // Update saved polygons in localStorage
            updateSavedPolygons();

            

            console.log('Polygon entity deleted:', polygonEntity);
        }
    }
}, Cesium.ScreenSpaceEventType.RIGHT_CLICK);



//delete all Polygons
function clearPolygons() {
    // Remove only polygon entities
    polygonEntitiesArray.forEach(function(polygonEntity) {
        viewer.entities.remove(polygonEntity);
    });
    
    // Clear the polygonEntitiesArray array
    polygonEntitiesArray = [];

    // Optionally, clear saved polygons from localStorage
    localStorage.removeItem('polygons');

    //Update the polygon counter
    updatePolygonCounter();
    
    console.log('Polygon entities cleared');
}



// Add an event listener to the delete polygons button
// Show the custom confirmation modal
document.getElementById('deletePolygon').addEventListener('click', function() {
    document.getElementById('confirmationModal2').style.display = 'flex';
});

// Handle the OK button in the custom modal
document.getElementById('confirmDelete2').addEventListener('click', function() {
    clearPolygons();
    document.getElementById('confirmationModal2').style.display = 'none';
});

// Handle the Cancel button in the custom modal
document.getElementById('cancelDelete2').addEventListener('click', function() {
    document.getElementById('confirmationModal2').style.display = 'none';
});

//Funktionsleiste Button
document.getElementById('header2').style.display = 'flex';
document.getElementById('Funktionsleiste').addEventListener('click', function() {
  if (document.getElementById('header2').style.display === 'flex') {
  document.getElementById('header2').style.display = 'none';
  } 
  else  {
  document.getElementById('header2').style.display = 'flex';
  
  } 
});
//2D/3D Button  
//Function to switch 
function toggleView(pitchInDegrees, latitudeOffset, heightOffset) {
    var scene = viewer.scene;
    var camera = scene.camera;

    // Get the current camera position in Cartographic coordinates
  const currentPosition = viewer.camera.positionCartographic.clone();

// Calculate the new latitude with the offset
const newLatitude = currentPosition.latitude + Cesium.Math.toRadians(latitudeOffset);

// Calculate the new height with the offset
const newHeight = heightOffset;

// Create the new position with the updated latitude and height
const newPosition = Cesium.Cartesian3.fromRadians(
  currentPosition.longitude,
  newLatitude,
  newHeight
);
// Get the current heading of the camera
const currentHeading = viewer.camera.heading;
// Define the new orientation
const newOrientation = {
    heading: currentHeading,
    pitch: Cesium.Math.toRadians(pitchInDegrees)
  };
  viewer.camera.flyTo({
    //destination: initialPosition,
    //orientation: initialOrientation,
    destination: newPosition,
  orientation: newOrientation,
    duration: 1.0
  })
};

let toggleState= false
// Button Functionality
document.getElementById('zweid3dButton').addEventListener('click', () => {
  if (toggleState) {
        // Call the function with the first set of parameters
        toggleView(-15, -0.01, 600);
    } else {
        // Call the function with the second set of parameters
        toggleView(-90, 0.01, 1200);
    }
    // Toggle the state
    toggleState = !toggleState;
});

//Rain Animation
const rainContainer = document.getElementById('rain');
const startRainButton = document.getElementById('StartRainButton');
const stopRainButton = document.getElementById('StopRainButton');
const lightRainCheckbox = document.getElementById('lightRain');
const heavyRainCheckbox = document.getElementById('heavyRain');

let isRaining = false;
let numberOfDrops = 0;
let speed = 1.2;

startRainButton.addEventListener('click', toggleRain);

// Event listeners to ensure mutual exclusivity
lightRainCheckbox.addEventListener('change', () => {
    if (lightRainCheckbox.checked) {
        heavyRainCheckbox.checked = false;
    }
    updateRainIntensity();
});

heavyRainCheckbox.addEventListener('change', () => {
    if (heavyRainCheckbox.checked) {
        lightRainCheckbox.checked = false;
    }
    updateRainIntensity();
});
 

function toggleRain() {
    isRaining = !isRaining;

    if (isRaining) {
      
         // Enable light rain by default
         lightRainCheckbox.checked = true;
        heavyRainCheckbox.checked = false;
        updateRainIntensity(); // Update the intensity based on the default light rain
        startRain();
        
        //startRainButton.innerHTML = 'Stop Rain';
    } else {
      
        stopRain();
        //startRainButton.innerText = 'Start Rain';
        
    }
    updateButtonState();
}

function startRain() {
  rainContainer.innerHTML = ''; // Clear existing drops if any
  document.getElementById('StartRainButton').style.display = 'none';
  document.getElementById('StopRainButton').style.display = 'inline-block';
  document.getElementById('RainIntensity').style.display = 'inline-block';
    for (let i = 0; i < numberOfDrops; i++) {
        const drop = document.createElement('div');
        drop.classList.add('drop');
        drop.style.left = `${Math.random() * 100}vw`;
        drop.style.animationDuration = `${(Math.random() * 0.5 + 0.5) * speed}s`;
        drop.style.animationDelay = `${Math.random() * 2}s`;
        rainContainer.appendChild(drop);
        wmsStarkregenSelten.show = true;
        wmsStarkregenSeltenCheckbox.checked = true;
        document.getElementById('StartRainButton').style.display = 'none';
        document.getElementById('StopRainButton').style.display = 'inline-block';
          
    }
}

function stopRain() {
  
    rainContainer.innerHTML = ''; // Clear all drops
        lightRainCheckbox.checked = false;
        heavyRainCheckbox.checked = false;
        document.getElementById('StartRainButton').style.display = 'inline-block';
        document.getElementById('StopRainButton').style.display = 'none';
        document.getElementById('RainIntensity').style.display = 'none';
    if (wmsStarkregenSeltenCheckbox.checked=true) {
      wmsStarkregenSeltenCheckbox.checked = false, 
      wmsStarkregenSelten.show = false;
      document.getElementById('StartRainButton').style.display = 'inline-block';
      document.getElementById('StopRainButton').style.display = 'none';
        }
    if (wmsStarkregenExtremCheckbox.checked=true) {
      wmsStarkregenExtremCheckbox.checked = false, 
      wmsStarkregenExtrem.show = false; 
      document.getElementById('StartRainButton').style.display = 'inline-block';
      document.getElementById('StopRainButton').style.display = 'none';
    }
    document.getElementById('StartRainButton').style.display = 'inline-block';
    document.getElementById('StopRainButton').style.display = 'none';
}
function updateRainIntensity() {
    if (lightRainCheckbox.checked) {
        numberOfDrops = 250;
        speed = 1.5; // Slower
        heavyRainCheckbox.checked = false;// Ensure the other checkbox is unchecked
        
        wmsStarkregenSeltenCheckbox.checked = true; 
        wmsStarkregenSelten.show = true;
        wmsStarkregenExtremCheckbox.checked = false;
        wmsStarkregenExtrem.show = false
    } else if (heavyRainCheckbox.checked) {
        numberOfDrops = 1000;
        speed = 0.8; // Faster
        lightRainCheckbox.checked = false; // Ensure the other checkbox is unchecked
        wmsStarkregenSeltenCheckbox.checked = false; 
        wmsStarkregenSelten.show = false;
        wmsStarkregenExtremCheckbox.checked = true;
        wmsStarkregenExtrem.show = true
    } 
    
    else {
        // Default rain intensity if no checkbox is selected
        numberOfDrops = 0;
        speed = 1.2;
        startRainButton.style.display = 'inline-block';
        stopRainButton.style.display = 'none';
        stopRain();
        
    }

    if (isRaining) {
        
        startRain(); // Restart the rain with the new intensity
    }
}
function updateButtonState() {
    if (isRaining) {
        startRainButton.style.display = 'none';
        stopRainButton.style.display = 'inline-block';
    } else if (!isRaining) {
        startRainButton.style.display = 'inline-block';
        stopRainButton.style.display = 'none';
    }
}

//Stop Rain Button Functionality
document.getElementById('StopRainButton').addEventListener('click', () => {
    stopRain();
    document.getElementById('StartRainButton').style.display = 'inline-block';
    document.getElementById('StopRainButton').style.display = 'none';
})
   

 //Layer Button
 document.getElementById('layerlist').style.display = 'none';
 document.getElementById('layerbutton').addEventListener('click', () => {
  if (document.getElementById('layerlist').style.display === 'block') {
  document.getElementById('layerlist').style.display = 'none';
  } 
  else  {
  document.getElementById('layerlist').style.display = 'block';
  
  } 
});

//Legend Button
document.getElementById('legend').style.display = 'none';
document.getElementById('legendbutton').addEventListener('click', () => {
  if (document.getElementById('legend').style.display === 'none') {
  document.getElementById('legend').style.display = 'block';
  } 
  else  {
  document.getElementById('legend').style.display = 'none';
  } 
});
//Layers
    // Cesium OSM Buildings
    const OSMbuildingTileset = await Cesium.createOsmBuildingsAsync();
    viewer.scene.primitives.add(OSMbuildingTileset);   

    //GooglePhotorealistic Tiles   --> während Entwicklung deaktivieren!!!
    const GoogletilesetKoeln = await Cesium.Cesium3DTileset.fromUrl(
     "https://tile.googleapis.com/v1/3dtiles/root.json?key=AIzaSyBxBAlQUUqEie5k66Ki7Oc5OFJise2Jud8"
  );
    GoogletilesetKoeln.show = false;
    viewer.scene.primitives.add(GoogletilesetKoeln);
    

    //LoD2 Koeln - Styling auch möglich  
    // von Cesium Ion 
    const LoD2Koeln = await Cesium.Cesium3DTileset.fromIonAssetId(2663459);
    viewer.scene.primitives.add(LoD2Koeln);
   
      const wmsHQ10ImageryProvider = new Cesium.WebMapServiceImageryProvider({
            url : 'https://www.wms.nrw.de/umwelt/HW_Gefahrenkarte?',
            layers : '15',
            parameters : {
                service: 'WMS',
                version: '1.1.1',
                request: 'GetMap',
                styles: '',
                format: 'image/png',
                transparent: true
            }
        });
        const wmsHQ10 = viewer.imageryLayers.addImageryProvider(wmsHQ10ImageryProvider);
        

         //HQ100  
      const wmsHQ100ImageryProvider = new Cesium.WebMapServiceImageryProvider({
            url : 'https://www.wms.nrw.de/umwelt/HW_Gefahrenkarte?',
            layers : '10', 
            parameters : {
                service: 'WMS',
                version: '1.1.1',
                request: 'GetMap',
                styles: '',
                format: 'image/png',
                transparent: true
            }
        });
       const wmsHQ100 = viewer.imageryLayers.addImageryProvider(wmsHQ100ImageryProvider);
        
        //HQ500  
      const wmsHQ500ImageryProvider = new Cesium.WebMapServiceImageryProvider({
            url : 'https://www.wms.nrw.de/umwelt/HW_Gefahrenkarte?',
            layers : '5',
            parameters : {
                service: 'WMS',
                version: '1.1.1',
                request: 'GetMap',
                styles: '',
                format: 'image/png',
                transparent: true
            }
        });
       const wmsHQ500 = viewer.imageryLayers.addImageryProvider(wmsHQ500ImageryProvider);
       
  //Hochwasser 3D 
//HQSelten als GEOJSON mit Höhenversatz zur 3D Ansicht
const resource2 = await Cesium.IonResource.fromAssetId(2606015);
const HQselten3D_UG = await Cesium.GeoJsonDataSource.load(resource2, {
  clampToGround: false,
});

viewer.dataSources.add(HQselten3D_UG);

// Iterate through all entities and set extrusion and height.
var entities = HQselten3D_UG.entities.values;
for (var i = 0; i < entities.length; i++) {
  var entity = entities[i];

  if (Cesium.defined(entity.polygon)) {
    // Set the base height and extruded height.
    entity.polygon.height = 100.5; // Base height in meters.
    entity.polygon.extrudedHeight = -10; // Extruded height in meters.

    // Optional: Set the material of the polygon.
    entity.polygon.material = Cesium.Color.YELLOW.withAlpha(0.5);

    // Optional: Set the outline color and width.
    entity.polygon.outline = false;
    entity.polygon.outlineColor = Cesium.Color.BLACK;
    entity.polygon.outlineWidth = 2.0;
  }
}


//HQSelten als GEOJSON mit Höhenversatz zur 3D Ansicht
const resource1 = await Cesium.IonResource.fromAssetId(2606014);
const HQselten3D = await Cesium.GeoJsonDataSource.load(resource1, {
  clampToGround: false,
});

viewer.dataSources.add(HQselten3D);

// Iterate through all entities and set extrusion and height.
var entities = HQselten3D.entities.values;
for (var i = 0; i < entities.length; i++) {
  var entity = entities[i];

  if (Cesium.defined(entity.polygon)) {
    // Set the base height and extruded height.
    entity.polygon.height = 100.5; // Base height in meters.
    entity.polygon.extrudedHeight = -10; // Extruded height in meters.

    // Optional: Set the material of the polygon.
    entity.polygon.material = Cesium.Color.BLUE.withAlpha(0.6);

    // Optional: Set the outline color and width.
    entity.polygon.outline = false;
    entity.polygon.outlineColor = Cesium.Color.BLACK;
    entity.polygon.outlineWidth = 2.0;
  }
}



//HQExtrem als GEOJSON mit Höhenversatz zur 3D Ansicht
const resource = await Cesium.IonResource.fromAssetId(2606016);
const HQextrem3D = await Cesium.GeoJsonDataSource.load(resource, {
  clampToGround: false,
});

viewer.dataSources.add(HQextrem3D);

// Iterate through all entities and set extrusion and height.
var entities = HQextrem3D.entities.values;
for (var i = 0; i < entities.length; i++) {
  var entity = entities[i];

  if (Cesium.defined(entity.polygon)) {
    // Set the base height and extruded height.
    entity.polygon.height = 103.5; // Base height in meters.
    entity.polygon.extrudedHeight = -10; // Extruded height in meters.
    //entity.polygon.heightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;

    // Optional: Set the material of the polygon.
    entity.polygon.material = Cesium.Color.BLUE.withAlpha(0.6);

    // Optional: Set the outline color and width.
    entity.polygon.outline = false;
    entity.polygon.outlineColor = Cesium.Color.BLACK;
    entity.polygon.outlineWidth = 2.0;
  }
}

// Hide the data source after it has been added and processed
HQextrem3D.show = false;
HQselten3D.show = false;
HQselten3D_UG.show = false;


       //Starkregen WMS  --> unter Hochwasser damit die Layer über Hochwasser liegen
      //Seltenes Ereignis
      const wmsStarkregenSeltenImageryProvider = new Cesium.WebMapServiceImageryProvider({
            url : 'https://sgx.geodatenzentrum.de/wms_starkregen?',
            layers : 'wasserhoehen_selten',
            parameters : {
                service: 'WMS',
                version: '1.1.1',
                request: 'GetMap',
                styles: '',
                format: 'image/png',
                transparent: true
            }
        });
        const wmsStarkregenSelten = viewer.imageryLayers.addImageryProvider(wmsStarkregenSeltenImageryProvider);

        //Starkregen Extrem
      const wmsStarkregenExtremImageryProvider = new Cesium.WebMapServiceImageryProvider({
            url : 'https://sgx.geodatenzentrum.de/wms_starkregen?',
            layers : 'wasserhoehen_extrem',
            parameters : {
                service: 'WMS',
                version: '1.1.1',
                request: 'GetMap',
                styles: '',
                format: 'image/png',
                transparent: true
            }
        });
       const wmsStarkregenExtrem =viewer.imageryLayers.addImageryProvider(wmsStarkregenExtremImageryProvider);


// Load GeoJSON data into the viewer
        // As Entity
        const RheinPegel = viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(6.96340097,50.93693404),
            billboard: {
                image: 'img/Hochwasser_Pegel.png',
                scale: 1, 
                height: 50,
                width: 35,
                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND, // Clamps the billboard to the ground
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM, // Align the bottom of the billboard with the coordinate
                horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
                disableDepthTestDistance: Number.POSITIVE_INFINITY, // Ensure the billboard is always visible
                distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, Number.POSITIVE_INFINITY) // Always display the billboard
                
            }
            
        })
        //Set Name and Content für Rheinpegel Box
        RheinPegel.name= "Rhein Pegel Köln";
        RheinPegel.description= ` <iframe id="custom-iframe" width="100%" height="555px" src="https://www.pegelonline.wsv.de/charts/OnlineVisualisierungGanglinie?pegeluuid=a6ee8177-107b-47dd-bcfd-30960ccc6e9c" frameborder="0" allowfullscreen></iframe>`;
          //<p> Weitere Informationen: 
          //<a href="https://www.pegelonline.wsv.de/gast/pegeltabelle"> Rhein Pegel Köln</a>
          //</p>
          //`;

               
        
    //initial layer configuration
    OSMbuildingTileset.show = false;
    //GoogletilesetKoeln.show = true;
    LoD2Koeln.show = true;
        // Important for WMS services --> need to be stored as const to be able to use the .show property 
    wmsStarkregenSelten.show = false; 
    wmsStarkregenExtrem.show = false;
    wmsHQ10.show = false;
    wmsHQ100.show = false;
    wmsHQ500.show = false;
    
    RheinPegel.show = true;

    //hide/show layers
      //OSM
       document.getElementById('OSMCheckbox').addEventListener('change', () => {
        OSMbuildingTileset.show = !OSMbuildingTileset.show;
        });

      //Google Photorealistic
      document.getElementById('GooglePhotorealisticCheckbox').addEventListener('change', () => {
        GoogletilesetKoeln.show = !GoogletilesetKoeln.show;
        });

      //LoD2
      document.getElementById('LoD2Checkbox').addEventListener('change', () => {
        LoD2Koeln.show = !LoD2Koeln.show;
        });
        
      //Starkregen WMS
         //Selten
      document.getElementById('wmsStarkregenSeltenCheckbox').addEventListener('change', () => {
        wmsStarkregenSelten.show = !wmsStarkregenSelten.show;
        });
      //Extrem
      document.getElementById('wmsStarkregenExtremCheckbox').addEventListener('change', () => {
        wmsStarkregenExtrem.show = !wmsStarkregenExtrem.show;
        });

   //Rheinpegel
   document.getElementById('RheinPegelCheckbox').addEventListener('change', () => {
        RheinPegel.show = !RheinPegel.show;
        });


  // Hochwasser 3D
         //HQ10
      document.getElementById('HochwasserSelten3D').addEventListener('change', () => {
        HQselten3D.show = !HQselten3D.show;
        });
      //HQ100
      document.getElementById('HochwasserSelten3D_UG').addEventListener('change', () => {
        HQselten3D_UG.show = !HQselten3D_UG.show;
        });
      //HQ500
      document.getElementById('HochwasserExtrem3D').addEventListener('change', () => {
        HQextrem3D.show = !HQextrem3D.show;
        });


    //Favoriten
// Function to show all markers
function showAllMarkers() {
    for (var i = 0; i < FavoritenMarkersArray.length; i++) {
        FavoritenMarkersArray[i].show = true;
    }
}

// Function to hide all markers
function hideAllMarkers() {
    for (var i = 0; i < FavoritenMarkersArray.length; i++) {
        FavoritenMarkersArray[i].show = false;
    }
}

//Favoriten
    document.getElementById('FavoritenCheckbox').addEventListener('change', () => {
      
        FavoritenMarkersArray.show = !FavoritenMarkersArray.show;
        if (FavoritenMarkersArray.show) {
          hideAllMarkers();
          document.getElementById('FavoritenCheckbox').checked = false;
        } else {
          showAllMarkers();
          document.getElementById('FavoritenCheckbox').checked = true;
        }
        });


    //Polygone
    // Event listener for the checkbox to show/hide all polygons
document.getElementById('PolygonCheckbox').addEventListener('change', (event) => {
    const isChecked = event.target.checked;
    
    if (isChecked) {
        showAllPolygons();
    } else {
        hideAllPolygons();
    }
});

// Function to show all polygons
function showAllPolygons() {
    polygonEntitiesArray.forEach(function(polygonEntity) {
        polygonEntity.show = true;
    });
}

// Function to hide all polygons
function hideAllPolygons() {
    polygonEntitiesArray.forEach(function(polygonEntity) {
        polygonEntity.show = false;
    });
}


        //Hochwasser mit Slider
        document.getElementById('layerSlider').addEventListener('change', (event) => {
          if (layerSlider.value ==='0') {
            wmsHQ10.show = true;
            wmsHQ100.show = false;
            wmsHQ500.show = false;
            HochwasserCheckbox.checked === true;
          }
          else if (layerSlider.value ==='1') {
            wmsHQ10.show = false;
            wmsHQ100.show = true;
            wmsHQ500.show = false;
            HochwasserCheckbox.checked === true;
          }
          else if (layerSlider.value ==='2') {
            wmsHQ10.show = false;
            wmsHQ100.show = false;
            wmsHQ500.show = true;
            HochwasserCheckbox.checked === true;
          }
          
      });
     
        function updateLayers(value) {
                if (value === '0') {
                    wmsHQ10.show = true;
                    wmsHQ100.show = false;
                    wmsHQ500.show = false;
                    HochwasserCheckbox.checked = true;
                } else if (value === '1') {
                    wmsHQ10.show = false;
                    wmsHQ100.show = true;
                    wmsHQ500.show = false;
                    HochwasserCheckbox.checked = true;
                } else if (value === '2') {
                    wmsHQ10.show = false;
                    wmsHQ100.show = false;
                    wmsHQ500.show = true;
                    HochwasserCheckbox.checked = true;
                }
            };
            //updateLayers(layerSlider.value);

            // Event listener for slider input changes
            layerSlider.addEventListener('input', (event) => {
                updateLayers(event.target.value);
            });

            // Event listener for checkbox changes
            HochwasserCheckbox.addEventListener('change', (event) => {
                if (HochwasserCheckbox.checked) {
                    layerSlider.value = '0';
                    updateLayers('0');
                }
                else if (HochwasserCheckbox.checked === false) {
                    layerSlider.value = '0';
                    wmsHQ10.show = false;
                    wmsHQ100.show = false;
                    wmsHQ500.show = false;
                }
            });

     
            //Boat Animation
let polyline; // Declare polyline in the global scope
let boatEntity; // Declare boatEntity in the global scope

  async function animateBoat() {
    
  const boat =  await Cesium.IonResource.fromAssetId(2699733);
  
  
  
  // Define the position of the boat using Cartesian3
  const position = Cesium.Cartesian3.fromDegrees(6.966, 50.945);

  // Define the heading, pitch, and roll (in radians) for the orientation
  const heading = Cesium.Math.toRadians(90); // Heading: rotation around the vertical axis (Z-axis)
  const pitch = Cesium.Math.toRadians(0); // Pitch: rotation around the lateral axis (X-axis)
  const roll = Cesium.Math.toRadians(0); // Roll: rotation around the longitudinal axis (Y-axis)

  // Create the orientation quaternion from heading, pitch, and roll
  const orientation = Cesium.Transforms.headingPitchRollQuaternion(position, new Cesium.HeadingPitchRoll(heading, pitch, roll));


  // Add the boat entity with position, orientation, and scale
  boatEntity = viewer.entities.add({
    position: position,
    orientation: orientation,
    model: {
      uri: boat,
      scale: 50,  // Adjust the scale as needed
      heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
      color: Cesium.Color.GOLD,
    },
  });

//waypoints for the boat
const waypoints = [
    Cesium.Cartesian3.fromDegrees(6.966, 50.945),
    Cesium.Cartesian3.fromDegrees(6.966, 50.935),
    // Add more waypoints as needed
];
 //waypoints for the boat as line
 polyline = viewer.entities.add({
    polyline: {
        positions: waypoints,
        width: 5,
        material: Cesium.Color.TRANSPARENT,
        clampToGround: true  // Clamps the polyline to the terrain
    }
});
//boatEntity.show = false;

//Animation
// Animation
const start = Cesium.JulianDate.now();
const stop = Cesium.JulianDate.addSeconds(start, 100, new Cesium.JulianDate());

viewer.clock.startTime = start.clone();
viewer.clock.stopTime = stop.clone();
viewer.clock.currentTime = start.clone();
viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP; // Loop at the end
viewer.clock.multiplier = 1; // Adjust speed as needed

const positionProperty = new Cesium.SampledPositionProperty();

// Enable interpolation (for smooth motion between samples)
positionProperty.setInterpolationOptions({
    interpolationDegree: 5, // Adjust the degree of interpolation (1 is linear, higher values give smoother results)
    interpolationAlgorithm: Cesium.LagrangePolynomialApproximation // Choose an interpolation algorithm
});

// Enable extrapolation (continue moving even outside sample time range)
positionProperty.forwardExtrapolationType = Cesium.ExtrapolationType.HOLD;
positionProperty.backwardExtrapolationType = Cesium.ExtrapolationType.HOLD;

for (let i = 0; i < waypoints.length; i++) {
    const time = Cesium.JulianDate.addSeconds(start, i * 10, new Cesium.JulianDate());
    positionProperty.addSample(time, waypoints[i]);
}

boatEntity.position = positionProperty;

// Ensure the boat faces the direction of travel
boatEntity.orientation = new Cesium.VelocityOrientationProperty(positionProperty);

viewer.clock.shouldAnimate = true;
}

document.getElementById('boat').addEventListener('click', () => {
  if (polyline) {
        console.log('Removing polyline');
        viewer.entities.remove(polyline); // Remove the polyline from the viewer
        polyline = null; // Clear the reference
    }

    if (boatEntity) {
        console.log('Removing boat');
        viewer.entities.remove(boatEntity); // Remove the boat entity from the viewer
        boatEntity = null; // Clear the reference
    }
  animateBoat();
  document.getElementById('startBoat').style.display = 'inline-block';
  document.getElementById('stopBoat').style.display = 'inline-block';

});
document.getElementById('startBoat').addEventListener('click', () => {
  if (polyline) {
        console.log('Removing polyline');
        viewer.entities.remove(polyline); // Remove the polyline from the viewer
        polyline = null; // Clear the reference
    }

    if (boatEntity) {
        console.log('Removing boat');
        viewer.entities.remove(boatEntity); // Remove the boat entity from the viewer
        boatEntity = null; // Clear the reference
    }
    animateBoat();
});
document.getElementById('stopBoat').addEventListener('click', () => {
    

  if (polyline) {
        console.log('Removing polyline');
        viewer.entities.remove(polyline); // Remove the polyline from the viewer
        polyline = null; // Clear the reference
    }

    if (boatEntity) {
        console.log('Removing boat');
        viewer.entities.remove(boatEntity); // Remove the boat entity from the viewer
        boatEntity = null; // Clear the reference
    }
    viewer.clock.shouldAnimate = false;
    document.getElementById('startBoat').style.display = 'none';
  document.getElementById('stopBoat').style.display = 'none';
});

</script>
</body>
</html>
        
    
  </script>

</body>

</html>
